<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>対戦記録（ローカル保存＋バックアップ）</title>
  <style>
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin:0; background:#f4f4f4; font-size:14px;
    }
    header{
      background:#333; color:#fff; padding:12px 16px;
    }
    header h1{ margin:0; font-size:18px; line-height:1.2; }
    main{ padding:16px; max-width:1100px; margin:0 auto; }
    .section{
      background:#fff; border-radius:6px; padding:12px 14px; margin-bottom:14px;
      box-shadow:0 1px 2px rgba(0,0,0,.08);
    }
    h2{ margin:0 0 8px 0; font-size:16px; border-left:4px solid #333; padding-left:8px; }
    h3{ margin:12px 0 6px 0; font-size:14px; }
    h4{ margin:8px 0 4px 0; font-size:13px; }
    label{ display:block; margin-top:8px; margin-bottom:4px; }
    input[type="text"], input[type="date"], input[type="number"], select, textarea{
      width:100%; box-sizing:border-box; border:1px solid #ccc; border-radius:4px;
      padding:8px 10px; font-size:14px; background:#fff;
    }
    input[type="file"]{ width:100%; font-size:13px; }
    textarea{ min-height:70px; resize:vertical; }
    button{
      padding:8px 12px; border-radius:4px; border:1px solid #333; background:#333; color:#fff;
      font-size:14px; cursor:pointer;
    }
    button.secondary{ background:#777; border-color:#777; }
    button.danger{ background:#b00020; border-color:#b00020; }
    button:disabled{ opacity:.5; cursor:default; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .row > div{ flex:1 1 160px; }
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th, td{ border:1px solid #ddd; padding:4px 6px; text-align:left; vertical-align:top; word-break:break-word; }
    th{ background:#f0f0f0; }
    .small{ font-size:12px; color:#666; line-height:1.55; }
    .hint{
      margin-top:10px; padding:10px 12px; border-radius:6px;
      background:#fff7e6; border:1px solid #ffe0a3; font-size:12px; line-height:1.55;
    }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; color:#fff; margin-right:6px; }
    .win{ background:#2e7d32; }
    .lose{ background:#c62828; }
    .stats{ margin-top:8px; font-size:13px; line-height:1.6; }
    .thumb{ max-width:60px; max-height:60px; display:block; }
    .match-date-group{
      margin-bottom:12px;
      border-top:2px solid #ccc;
      padding-top:8px;
    }
    .match-date-title{
      font-weight:bold;
      margin-bottom:4px;
    }
    .match-stage-group{
      margin-left:4px;
      margin-bottom:8px;
    }
    .match-card{
      border:1px solid #ddd;
      border-radius:6px;
      padding:8px;
      margin-bottom:6px;
      background:#fafafa;
    }
    .match-card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:4px;
      font-size:13px;
      font-weight:bold;
    }
    .match-card-header span{
      flex:1 1 auto;
    }
    .match-card table{
      width:100%;
      margin-top:2px;
    }
    #currentDeckImageInfo{
      margin-top:4px;
    }
    #currentDeckImageInfo img{
      margin-top:4px;
    }
    #tournamentSummary table{
      width:100%;
    }
    #tournamentSummary tr{
      cursor:pointer;
    }
    #tournamentSummary tr:hover{
      background:#f7f7f7;
    }
  </style>
</head>
<body>
<header>
  <h1>対戦記録（ローカル保存＋バックアップ）</h1>
</header>

<main>
  <!-- 1. 対戦を記録 -->
  <section class="section">
    <h2>対戦を記録</h2>

    <h3>対戦を追加 / 編集</h3>

    <label for="matchDate">対戦日（大会日）</label>
    <input type="date" id="matchDate" />

    <label for="tournamentName">大会名</label>
    <input type="text" id="tournamentName" placeholder="例：〇〇CS（空なら『大会』として保存）" />

    <label for="matchStage">ステージ</label>
    <select id="matchStage">
      <option value="予選">予選</option>
      <option value="本戦">本戦</option>
    </select>

    <label for="matchDeckName">使用デッキ名</label>
    <input type="text" id="matchDeckName" placeholder="例：青黒サガ" />

    <label for="matchDeckImage">デッキ画像（任意・1枚）</label>
    <input type="file" id="matchDeckImage" accept="image/*" />
    <div class="small">画像は対戦ごとに保存されます。画像を変更しない場合はそのままでかまいません。</div>
    <div id="currentDeckImageInfo" class="small" style="display:none;">
      現在のデッキ画像:
      <br>
      <img id="currentDeckImagePreview" class="thumb" alt="deck image preview">
    </div>

    <div class="row">
      <div>
        <label for="matchRound">ラウンド（空なら自動で1,2,…）</label>
        <input type="number" id="matchRound" min="1" placeholder="空のままでOK" />
      </div>
      <div>
        <label for="matchFirstSecond">先手／後手</label>
        <select id="matchFirstSecond">
          <option value="">選択</option>
          <option value="先手">先手</option>
          <option value="後手">後手</option>
        </select>
      </div>
      <div>
        <label for="matchResult">勝敗</label>
        <select id="matchResult">
          <option value="">選択</option>
          <option value="勝ち">勝ち</option>
          <option value="負け">負け</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="matchOpponentDeck">相手デッキ名（任意）</label>
        <input type="text" id="matchOpponentDeck" placeholder="例：赤青マジック" />
      </div>
    </div>

    <label for="matchMemo">メモ（任意）</label>
    <textarea id="matchMemo" placeholder="プレイの反省点など"></textarea>

    <div class="row" style="margin-top:8px;">
      <div>
        <button id="addMatchButton">対戦を追加</button>
      </div>
      <div>
        <button id="cancelEditButton" class="secondary" style="display:none;">編集をキャンセル</button>
      </div>
    </div>
    <div id="editStatus" class="small"></div>
  </section>

  <!-- 2. 対戦結果（大会ごとの結果＋一覧） -->
  <section class="section">
    <h2>対戦結果</h2>

    <h3>大会ごとの結果（大会名＋日付）</h3>
    <div id="tournamentSummary"></div>

    <h3 style="margin-top:12px;">対戦一覧（大会ごと → 予選・本戦）</h3>
    <div class="stats" id="overallStats"></div>
    <div id="matchList"></div>
  </section>

  <!-- 3. 勝率計算（期間集計） -->
  <section class="section">
    <h2>勝率計算（期間で集計）</h2>

    <label for="periodStart">開始日（対戦日）</label>
    <input type="date" id="periodStart" />

    <label for="periodEnd">終了日（対戦日）</label>
    <input type="date" id="periodEnd" />

    <button id="calcPeriodButton">この期間で集計する</button>

    <div class="small">
      対戦日の範囲で集計します。開始日か終了日を空欄にすると、その側は制限なしになります。
    </div>

    <div id="periodResult" class="stats"></div>
  </section>

  <!-- 4. バックアップ・データ削除（いちばん下） -->
  <section class="section">
    <h2>バックアップ・データ削除</h2>

    <div class="row">
      <div>
        <button class="secondary" id="exportButton">バックアップを書き出し（JSON）</button>
        <div class="small">iPhone・Androidでは「ファイル」に保存できます。</div>
      </div>
      <div>
        <label for="importFile">バックアップを読み込む（JSON）</label>
        <input type="file" id="importFile" accept="application/json" />
        <button class="secondary" id="importButton">読み込みして復元</button>
      </div>
    </div>

    <div class="hint">
      復元をすると、今のデータは上書きされます。復元前に、必ず書き出し（バックアップ）を取ってください。<br>
      ブラウザの「履歴とWebサイトデータの削除」などを行うと、このアプリの記録が消える可能性があります。
    </div>

    <div style="margin-top:12px;">
      <button class="danger" id="resetDataButton">保存データを全部削除</button>
      <div class="small">
        すべての対戦データが消えます。バックアップを書き出してから実行してください。
      </div>
    </div>
  </section>
</main>

<script>
  // v10: matches のみ。大会は「大会名＋日付」で管理。
  const STORAGE_KEY = "dm_match_tracker_data_v10";

  function normalizeMatchesOnly(data){
    if(!data || typeof data !== "object"){
      return { matches: [] };
    }
    if(!Array.isArray(data.matches)){
      data.matches = [];
    }
    for(const m of data.matches){
      if(!m.stage) m.stage = "予選";
      if(!m.tournamentName){
        if(m.tournamentIndex != null){
          const ti = parseInt(m.tournamentIndex,10);
          if(Number.isInteger(ti) && ti >= 1){
            m.tournamentName = `第${ti}大会`;
          }else{
            m.tournamentName = "大会";
          }
        }else{
          m.tournamentName = "大会";
        }
      }
    }
    return { matches: data.matches };
  }

  function migrateFromOld(data){
    if(!data || typeof data !== "object"){
      return { matches: [] };
    }
    if(!Array.isArray(data.matches)){
      return { matches: [] };
    }

    const tournaments = Array.isArray(data.tournaments) ? data.tournaments : [];
    const decks = Array.isArray(data.decks) ? data.decks : [];

    const tMap = {};
    for(const t of tournaments){
      if(t && t.id && t.date){
        tMap[t.id] = t.date;
      }
    }

    const deckMap = {};
    for(const d of decks){
      if(d && d.id){
        deckMap[d.id] = {
          name: typeof d.name === "string" ? d.name : "",
          imageDataUrl: d.imageDataUrl || null
        };
      }
    }

    const newMatches = [];
    for(const m of data.matches){
      if(!m || typeof m !== "object") continue;

      let matchDate = m.matchDate || "";
      if(!matchDate && m.tournamentId && tMap[m.tournamentId]){
        matchDate = tMap[m.tournamentId];
      }

      let deckName = "";
      let deckImageDataUrl = null;
      if(m.deckId && deckMap[m.deckId]){
        deckName = deckMap[m.deckId].name;
        deckImageDataUrl = deckMap[m.deckId].imageDataUrl || null;
      }

      let tName = m.tournamentName;
      if(!tName){
        const ti = parseInt(m.tournamentIndex,10);
        if(Number.isInteger(ti) && ti >= 1){
          tName = `第${ti}大会`;
        }else{
          tName = "大会";
        }
      }

      newMatches.push({
        id: typeof m.id === "string" ? m.id : genId("match"),
        matchDate: matchDate || "",
        tournamentName: tName,
        stage: m.stage || "予選",
        deckName: m.deckName || deckName || "",
        deckImageDataUrl: m.deckImageDataUrl || deckImageDataUrl || null,
        roundNumber: m.roundNumber || null,
        firstOrSecond: m.firstOrSecond || "",
        result: m.result || "",
        opponentDeckName: m.opponentDeckName || "",
        memo: m.memo || "",
        createdAt: m.createdAt || ""
      });
    }

    return normalizeMatchesOnly({ matches: newMatches });
  }

  function loadData(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      try{
        const data = JSON.parse(raw);
        return normalizeMatchesOnly(data);
      }catch{
        return { matches: [] };
      }
    }

    const oldKeys = [
      "dm_match_tracker_data_v9",
      "dm_match_tracker_data_v8",
      "dm_match_tracker_data_v7",
      "dm_match_tracker_data_v6",
      "dm_match_tracker_data_v5",
      "dm_match_tracker_data_v4",
      "dm_match_tracker_data_v3"
    ];

    for(const key of oldKeys){
      const r = localStorage.getItem(key);
      if(!r) continue;
      try{
        const d = JSON.parse(r);
        let migrated;
        if(key === "dm_match_tracker_data_v9" ||
           key === "dm_match_tracker_data_v8" ||
           key === "dm_match_tracker_data_v7" ||
           key === "dm_match_tracker_data_v6" ||
           key === "dm_match_tracker_data_v5"){
          migrated = normalizeMatchesOnly(d);
        }else{
          migrated = migrateFromOld(d);
        }
        saveData(migrated);
        return migrated;
      }catch{
        continue;
      }
    }

    return { matches: [] };
  }

  function saveData(data){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function genId(prefix){
    return prefix + "_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
  }

  function escapeHtml(v){
    return String(v ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function nowFileTime(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()+0).padStart(2,"0");
    const mi = String(d.getMinutes()+0).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}_${hh}${mi}`;
  }

  function createdAtString(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()+0).padStart(2,"0");
    const mi = String(d.getMinutes()+0).padStart(2,"0");
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
  }

  function todayDate(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function validateImportedData(data){
    if(!data || typeof data !== "object") return "JSONの中身が不正です。";

    if(Array.isArray(data.matches) && !Array.isArray(data.decks) && !Array.isArray(data.tournaments)){
      for(const m of data.matches){
        if(!m || typeof m !== "object") return "対戦データが不正です。";
      }
      return null;
    }

    if(Array.isArray(data.matches) && (Array.isArray(data.decks) || Array.isArray(data.tournaments))){
      return null;
    }

    return "形式が対応外です。";
  }

  let appData = loadData();
  let editingMatchId = null;

  function overallStats(){
    let total = 0, win = 0, lose = 0;
    for(const m of appData.matches){
      total++;
      if(m.result === "勝ち") win++;
      if(m.result === "負け") lose++;
    }
    return { total, win, lose };
  }

  function percent(win, total){
    if(!total) return null;
    return Math.round((win / total) * 1000) / 10;
  }

  function nextRoundNumber(matchDate, tournamentName, stage){
    let max = 0;
    for(const m of appData.matches){
      const st = m.stage || "予選";
      const tn = m.tournamentName || "大会";
      if(m.matchDate === matchDate && st === stage && tn === tournamentName){
        const r = m.roundNumber || 0;
        if(r > max) max = r;
      }
    }
    return max + 1;
  }

  function makeTournamentKey(tName, date){
    const name = tName || "大会名未設定";
    const d = date || "日付未設定";
    return name + "||" + d;
  }

  function safeAnchorId(tName, date){
    const name = (tName || "no_name").replace(/[^a-zA-Z0-9\u00C0-\uFFFF]+/g, "");
    const d = (date || "nodate").replace(/[^0-9]+/g, "");
    return "group-" + name + "-" + d;
  }

  function renderTournamentSummary(){
    const div = document.getElementById("tournamentSummary");
    div.innerHTML = "";

    if(appData.matches.length === 0){
      div.textContent = "まだ大会ごとの結果はありません。";
      return;
    }

    const byTournament = {};
    for(const m of appData.matches){
      const date = m.matchDate || "日付未設定";
      const tName = m.tournamentName || "大会名未設定";
      const key = makeTournamentKey(tName, date);
      if(!byTournament[key]) byTournament[key] = [];
      byTournament[key].push(m);
    }

    const keys = Object.keys(byTournament).sort((a,b) => {
      const [na, da] = a.split("||");
      const [nb, db] = b.split("||");
      if(da === db){
        return na.localeCompare(nb, "ja");
      }
      if(da === "日付未設定") return -1;
      if(db === "日付未設定") return 1;
      return da < db ? -1 : 1;
    });

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    thead.innerHTML = "<tr><th>大会名</th><th>日付</th><th>対戦数</th><th>勝ち</th><th>負け</th><th>勝率</th></tr>";
    table.appendChild(thead);
    const tbody = document.createElement("tbody");

    for(const key of keys){
      const [tName, date] = key.split("||");
      const ms = byTournament[key];
      let total = ms.length;
      let win = 0;
      let lose = 0;
      for(const m of ms){
        if(m.result === "勝ち") win++;
        if(m.result === "負け") lose++;
      }
      const rate = percent(win, total);
      const tr = document.createElement("tr");
      tr.dataset.key = key;

      const tdName = document.createElement("td");
      tdName.textContent = tName || "大会名未設定";
      const tdDate = document.createElement("td");
      tdDate.textContent = date === "日付未設定" ? "日付未設定" : date;
      const tdTotal = document.createElement("td");
      tdTotal.textContent = String(total);
      const tdWin = document.createElement("td");
      tdWin.textContent = String(win);
      const tdLose = document.createElement("td");
      tdLose.textContent = String(lose);
      const tdRate = document.createElement("td");
      tdRate.textContent = rate != null ? `${rate}%` : "";

      tr.appendChild(tdName);
      tr.appendChild(tdDate);
      tr.appendChild(tdTotal);
      tr.appendChild(tdWin);
      tr.appendChild(tdLose);
      tr.appendChild(tdRate);

      tbody.appendChild(tr);
    }

    table.appendChild(tbody);
    div.appendChild(table);

    tbody.querySelectorAll("tr").forEach(tr => {
      tr.addEventListener("click", () => {
        const key = tr.dataset.key;
        if(!key) return;
        const [tName, date] = key.split("||");
        if(date === "日付未設定") return;
        const anchorId = safeAnchorId(tName, date);
        const target = document.getElementById(anchorId);
        if(target){
          window.scrollTo({
            top: target.getBoundingClientRect().top + window.scrollY - 80,
            behavior: "smooth"
          });
        }
      });
    });
  }

  function renderMatches(){
    const container = document.getElementById("matchList");
    container.innerHTML = "";

    const list = [...appData.matches].sort((a,b) => {
      const da = a.matchDate || "";
      const db = b.matchDate || "";
      if(da === db){
        const na = a.tournamentName || "大会";
        const nb = b.tournamentName || "大会";
        if(na === nb){
          const sa = a.stage || "予選";
          const sb = b.stage || "予選";
          if(sa === sb){
            return (a.roundNumber || 0) - (b.roundNumber || 0);
          }
          const order = { "予選": 1, "本戦": 2 };
          const oa = order[sa] || 99;
          const ob = order[sb] || 99;
          return oa - ob;
        }
        return na.localeCompare(nb, "ja");
      }
      return da < db ? -1 : 1;
    });

    const s = overallStats();
    const rate = percent(s.win, s.total);
    const overallDiv = document.getElementById("overallStats");
    if(!s.total){
      overallDiv.textContent = "まだ対戦記録がありません。";
    }else{
      overallDiv.textContent =
        `全対戦数: ${s.total}　勝ち: ${s.win}　負け: ${s.lose}` +
        (rate != null ? `　勝率: ${rate}%` : "");
    }

    if(list.length === 0){
      renderTournamentSummary();
      return;
    }

    const byTournament = {};
    for(const m of list){
      const date = m.matchDate || "日付未設定";
      const tName = m.tournamentName || "大会名未設定";
      const key = makeTournamentKey(tName, date);
      if(!byTournament[key]) byTournament[key] = [];
      byTournament[key].push(m);
    }

    const keys = Object.keys(byTournament).sort((a,b) => {
      const [na, da] = a.split("||");
      const [nb, db] = b.split("||");
      if(da === db){
        return na.localeCompare(nb, "ja");
      }
      if(da === "日付未設定") return -1;
      if(db === "日付未設定") return 1;
      return da < db ? -1 : 1;
    });

    for(const key of keys){
      const [tName, date] = key.split("||");
      const ms = byTournament[key];

      const groupDiv = document.createElement("div");
      groupDiv.className = "match-date-group";
      if(date !== "日付未設定"){
        groupDiv.id = safeAnchorId(tName, date);
      }

      const titleDiv = document.createElement("div");
      titleDiv.className = "match-date-title";
      const nameText = tName || "大会名未設定";
      const dateText = date === "日付未設定" ? "日付未設定" : date;
      titleDiv.textContent = `${nameText}（${dateText}）`;
      groupDiv.appendChild(titleDiv);

      const stages = ["予選", "本戦"];
      for(const stage of stages){
        const msStage = ms.filter(m => (m.stage || "予選") === stage);
        if(msStage.length === 0) continue;

        const stageDiv = document.createElement("div");
        stageDiv.className = "match-stage-group";

        const stageTitle = document.createElement("h4");
        stageTitle.textContent = stage;
        stageDiv.appendChild(stageTitle);

        for(const m of msStage){
          const card = document.createElement("div");
          card.className = "match-card";
          card.dataset.id = m.id;

          const header = document.createElement("div");
          header.className = "match-card-header";
          const infoSpan = document.createElement("span");
          const rText = m.roundNumber != null ? `R${m.roundNumber}` : "R-";
          infoSpan.textContent = `${rText}　${m.deckName || ""}`;
          const editBtn = document.createElement("button");
          editBtn.textContent = "編集";
          editBtn.className = "secondary match-edit-btn";
          editBtn.dataset.id = m.id;
          header.appendChild(infoSpan);
          header.appendChild(editBtn);
          card.appendChild(header);

          const table = document.createElement("table");
          const tbody = document.createElement("tbody");

          const rowDeckImg = document.createElement("tr");
          const thDeckImg = document.createElement("th");
          thDeckImg.textContent = "デッキ画像";
          const tdDeckImg = document.createElement("td");
          if(m.deckImageDataUrl){
            const img = document.createElement("img");
            img.src = m.deckImageDataUrl;
            img.alt = m.deckName || "";
            img.className = "thumb";
            tdDeckImg.appendChild(img);
          }else{
            tdDeckImg.textContent = "";
          }
          rowDeckImg.appendChild(thDeckImg);
          rowDeckImg.appendChild(tdDeckImg);
          tbody.appendChild(rowDeckImg);

          const rowDeck = document.createElement("tr");
          const thDeck = document.createElement("th");
          thDeck.textContent = "使用デッキ";
          const tdDeck = document.createElement("td");
          tdDeck.textContent = m.deckName || "";
          rowDeck.appendChild(thDeck);
          rowDeck.appendChild(tdDeck);
          tbody.appendChild(rowDeck);

          const rowFS = document.createElement("tr");
          const thFS = document.createElement("th");
          thFS.textContent = "先手／後手";
          const tdFS = document.createElement("td");
          tdFS.textContent = m.firstOrSecond || "";
          rowFS.appendChild(thFS);
          rowFS.appendChild(tdFS);
          tbody.appendChild(rowFS);

          const rowResult = document.createElement("tr");
          const thResult = document.createElement("th");
          thResult.textContent = "勝敗";
          const tdResult = document.createElement("td");
          if(m.result === "勝ち"){
            tdResult.innerHTML = `<span class="badge win">勝ち</span>`;
          }else if(m.result === "負け"){
            tdResult.innerHTML = `<span class="badge lose">負け</span>`;
          }else{
            tdResult.textContent = "";
          }
          rowResult.appendChild(thResult);
          rowResult.appendChild(tdResult);
          tbody.appendChild(rowResult);

          const rowOpp = document.createElement("tr");
          const thOpp = document.createElement("th");
          thOpp.textContent = "相手デッキ";
          const tdOpp = document.createElement("td");
          tdOpp.textContent = m.opponentDeckName || "";
          rowOpp.appendChild(thOpp);
          rowOpp.appendChild(tdOpp);
          tbody.appendChild(rowOpp);

          const rowMemo = document.createElement("tr");
          const thMemo = document.createElement("th");
          thMemo.textContent = "メモ";
          const tdMemo = document.createElement("td");
          tdMemo.textContent = m.memo || "";
          rowMemo.appendChild(thMemo);
          rowMemo.appendChild(tdMemo);
          tbody.appendChild(rowMemo);

          const rowCreated = document.createElement("tr");
          const thCreated = document.createElement("th");
          thCreated.textContent = "記録日時";
          const tdCreated = document.createElement("td");
          tdCreated.textContent = m.createdAt || "";
          rowCreated.appendChild(thCreated);
          rowCreated.appendChild(tdCreated);
          tbody.appendChild(rowCreated);

          table.appendChild(tbody);
          card.appendChild(table);
          stageDiv.appendChild(card);
        }

        groupDiv.appendChild(stageDiv);
      }

      container.appendChild(groupDiv);
    }

    document.querySelectorAll(".match-edit-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.id;
        const m = appData.matches.find(x => x.id === id);
        if(m) startEdit(m);
      });
    });

    renderTournamentSummary();
  }

  function calcPeriodStats(startDate, endDate){
    let total = 0;
    let win = 0;
    let lose = 0;
    let firstTotal = 0;
    let firstWin = 0;
    let secondTotal = 0;
    let secondWin = 0;

    for(const m of appData.matches){
      const d = m.matchDate;
      if(!d) continue;
      if(startDate && d < startDate) continue;
      if(endDate && d > endDate) continue;

      total++;
      if(m.result === "勝ち") win++;
      if(m.result === "負け") lose++;

      if(m.firstOrSecond === "先手"){
        firstTotal++;
        if(m.result === "勝ち") firstWin++;
      }
      if(m.firstOrSecond === "後手"){
        secondTotal++;
        if(m.result === "勝ち") secondWin++;
      }
    }

    return { total, win, lose, firstTotal, firstWin, secondTotal, secondWin };
  }

  function fillFormForEdit(m){
    document.getElementById("matchDate").value = m.matchDate || todayDate();
    document.getElementById("tournamentName").value = m.tournamentName || "";
    document.getElementById("matchStage").value = m.stage || "予選";
    document.getElementById("matchDeckName").value = m.deckName || "";
    document.getElementById("matchRound").value = m.roundNumber != null ? String(m.roundNumber) : "";
    document.getElementById("matchFirstSecond").value = m.firstOrSecond || "";
    document.getElementById("matchResult").value = m.result || "";
    document.getElementById("matchOpponentDeck").value = m.opponentDeckName || "";
    document.getElementById("matchMemo").value = m.memo || "";
    document.getElementById("matchDeckImage").value = "";

    const infoDiv = document.getElementById("currentDeckImageInfo");
    const img = document.getElementById("currentDeckImagePreview");
    if(m.deckImageDataUrl){
      infoDiv.style.display = "block";
      img.src = m.deckImageDataUrl;
    }else{
      infoDiv.style.display = "none";
      img.src = "";
    }
  }

  function clearFormAndEditState(){
    editingMatchId = null;
    document.getElementById("matchDate").value = todayDate();
    document.getElementById("tournamentName").value = "";
    document.getElementById("matchStage").value = "予選";
    document.getElementById("matchDeckName").value = "";
    document.getElementById("matchDeckImage").value = "";
    document.getElementById("matchRound").value = "";
    document.getElementById("matchFirstSecond").value = "";
    document.getElementById("matchResult").value = "";
    document.getElementById("matchOpponentDeck").value = "";
    document.getElementById("matchMemo").value = "";
    document.getElementById("currentDeckImageInfo").style.display = "none";
    document.getElementById("currentDeckImagePreview").src = "";
    document.getElementById("addMatchButton").textContent = "対戦を追加";
    document.getElementById("cancelEditButton").style.display = "none";
    document.getElementById("editStatus").textContent = "";
  }

  function startEdit(m){
    editingMatchId = m.id;
    fillFormForEdit(m);
    document.getElementById("addMatchButton").textContent = "対戦を更新";
    document.getElementById("cancelEditButton").style.display = "inline-block";
    const rText = m.roundNumber != null ? `R${m.roundNumber}` : "R-";
    document.getElementById("editStatus").textContent =
      `編集中: ${m.tournamentName || "大会"}（${m.matchDate || ""}） ${m.stage || "予選"} ${rText} ${m.deckName || ""}`;
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  document.getElementById("addMatchButton").addEventListener("click", () => {
    let matchDate = document.getElementById("matchDate").value;
    let tournamentName = document.getElementById("tournamentName").value.trim();
    const stage = document.getElementById("matchStage").value || "予選";
    const deckName = document.getElementById("matchDeckName").value.trim();
    const fileInput = document.getElementById("matchDeckImage");
    const file = fileInput.files && fileInput.files[0];
    const roundStr = document.getElementById("matchRound").value;
    const firstOrSecond = document.getElementById("matchFirstSecond").value;
    const result = document.getElementById("matchResult").value;
    const opponentDeckName = document.getElementById("matchOpponentDeck").value.trim();
    const memo = document.getElementById("matchMemo").value.trim();

    if(!matchDate){
      matchDate = todayDate();
    }
    if(!tournamentName){
      tournamentName = "大会";
    }
    if(!deckName){
      alert("使用デッキ名を入力してください。");
      return;
    }

    let roundNumber = null;
    if(roundStr){
      const parsed = parseInt(roundStr, 10);
      if(parsed > 0){
        roundNumber = parsed;
      }
    }
    if(!roundNumber){
      roundNumber = nextRoundNumber(matchDate, tournamentName, stage);
    }

    if(!firstOrSecond){
      alert("先手／後手を選択してください。");
      return;
    }
    if(!result){
      alert("勝敗（勝ち／負け）を選択してください。");
      return;
    }

    let existing = null;
    let existingImage = null;
    if(editingMatchId){
      existing = appData.matches.find(m => m.id === editingMatchId);
      if(existing){
        existingImage = existing.deckImageDataUrl || null;
      }
    }

    function saveWithImage(imageDataUrl){
      const finalImage = imageDataUrl !== null && imageDataUrl !== undefined
        ? imageDataUrl
        : existingImage;

      if(editingMatchId && existing){
        existing.matchDate = matchDate;
        existing.tournamentName = tournamentName;
        existing.stage = stage;
        existing.deckName = deckName;
        existing.deckImageDataUrl = finalImage || null;
        existing.roundNumber = roundNumber;
        existing.firstOrSecond = firstOrSecond;
        existing.result = result;
        existing.opponentDeckName = opponentDeckName;
        existing.memo = memo;
      }else{
        appData.matches.push({
          id: genId("match"),
          matchDate,
          tournamentName,
          stage,
          deckName,
          deckImageDataUrl: finalImage || null,
          roundNumber,
          firstOrSecond,
          result,
          opponentDeckName,
          memo,
          createdAt: createdAtString()
        });
      }

      saveData(appData);
      renderMatches();
      clearFormAndEditState();
    }

    if(file){
      const reader = new FileReader();
      reader.onload = () => {
        saveWithImage(String(reader.result || ""));
      };
      reader.readAsDataURL(file);
    }else{
      saveWithImage(null);
    }
  });

  document.getElementById("cancelEditButton").addEventListener("click", () => {
    clearFormAndEditState();
  });

  document.getElementById("resetDataButton").addEventListener("click", () => {
    const ok = confirm("保存している対戦データをすべて削除します。よろしいですか？");
    if(!ok) return;
    appData = { matches: [] };
    saveData(appData);
    renderMatches();
    document.getElementById("periodResult").textContent = "";
    clearFormAndEditState();
  });

  document.getElementById("exportButton").addEventListener("click", () => {
    const payload = {
      version: 10,
      exportedAt: new Date().toISOString(),
      matches: appData.matches
    };
    const json = JSON.stringify(payload, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `match_backup_${nowFileTime()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  document.getElementById("importButton").addEventListener("click", () => {
    const fileInput = document.getElementById("importFile");
    if(!fileInput.files || fileInput.files.length === 0){
      alert("読み込むJSONファイルを選択してください。");
      return;
    }

    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const data = JSON.parse(String(reader.result || ""));
        const err = validateImportedData(data);
        if(err){
          alert("復元できません：" + err);
          return;
        }

        let converted;
        if(Array.isArray(data.matches) && !Array.isArray(data.decks) && !Array.isArray(data.tournaments)){
          converted = normalizeMatchesOnly(data);
        }else{
          converted = migrateFromOld(data);
        }

        const ok = confirm("復元を実行します。今のデータは上書きされます。よろしいですか？");
        if(!ok) return;

        appData = converted;
        saveData(appData);
        renderMatches();
        document.getElementById("periodResult").textContent = "";
        fileInput.value = "";
        clearFormAndEditState();
        alert("復元しました。");
      }catch{
        alert("JSONの読み込みに失敗しました。");
      }
    };
    reader.readAsText(file, "utf-8");
  });

  document.getElementById("calcPeriodButton").addEventListener("click", () => {
    const startDate = document.getElementById("periodStart").value;
    const endDate = document.getElementById("periodEnd").value;

    if(startDate && endDate && startDate > endDate){
      alert("開始日は終了日以前にしてください。");
      return;
    }

    const stats = calcPeriodStats(startDate, endDate);
    const div = document.getElementById("periodResult");

    if(stats.total === 0){
      div.textContent = "この期間に集計対象の対戦はありません。";
      return;
    }

    const gameRate = percent(stats.win, stats.total);
    const firstRate = percent(stats.firstWin, stats.firstTotal);
    const secondRate = percent(stats.secondWin, stats.secondTotal);

    const startLabel = startDate || "指定なし";
    const endLabel = endDate || "指定なし";

    div.innerHTML =
      `対象期間: ${escapeHtml(startLabel)} 〜 ${escapeHtml(endLabel)}<br>` +
      `対戦数: ${stats.total}<br>` +
      `ゲーム勝率: 勝ち ${stats.win} / ${stats.total}` +
      (gameRate != null ? `（${gameRate}%）` : "") + `<br>` +
      `先手: 勝ち ${stats.firstWin} / ${stats.firstTotal}` +
      (firstRate != null ? `（${firstRate}%）` : "") + `<br>` +
      `後手: 勝ち ${stats.secondWin} / ${stats.secondTotal}` +
      (secondRate != null ? `（${secondRate}%）` : "");
  });

  function init(){
    document.getElementById("matchDate").value = todayDate();
    document.getElementById("matchStage").value = "予選";
    renderMatches();
  }
  init();
</script>
</body>
</html>
