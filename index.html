<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>対戦記録（ローカル保存＋バックアップ）</title>
  <style>
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin:0; background:#f4f4f4; font-size:14px;
    }
    header{
      background:#333; color:#fff; padding:12px 16px;
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    }
    header h1{ margin:0; font-size:18px; line-height:1.2; }
    main{ padding:16px; max-width:1100px; margin:0 auto; }
    .section{
      background:#fff; border-radius:6px; padding:12px 14px; margin-bottom:14px;
      box-shadow:0 1px 2px rgba(0,0,0,.08);
    }
    h2{ margin:0 0 8px 0; font-size:16px; border-left:4px solid #333; padding-left:8px; }
    h3{ margin:12px 0 6px 0; font-size:14px; }
    label{ display:block; margin-top:8px; margin-bottom:4px; }
    input[type="text"], input[type="date"], input[type="number"], select, textarea{
      width:100%; box-sizing:border-box; border:1px solid #ccc; border-radius:4px;
      padding:8px 10px; font-size:14px; background:#fff;
    }
    input[type="file"]{ width:100%; font-size:13px; }
    textarea{ min-height:70px; resize:vertical; }
    button{
      padding:8px 12px; border-radius:4px; border:1px solid #333; background:#333; color:#fff;
      font-size:14px; cursor:pointer;
    }
    button.secondary{ background:#777; border-color:#777; }
    button.danger{ background:#b00020; border-color:#b00020; }
    button:disabled{ opacity:.5; cursor:default; }
    .grid{ display:flex; gap:14px; flex-wrap:wrap; }
    .grid .section{ flex:1 1 320px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .row > div{ flex:1 1 160px; }
    table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:13px; }
    th, td{ border:1px solid #ddd; padding:6px 8px; text-align:left; vertical-align:top; word-break:break-word; }
    th{ background:#f0f0f0; }
    .small{ font-size:12px; color:#666; line-height:1.55; }
    .hint{
      margin-top:10px; padding:10px 12px; border-radius:6px;
      background:#fff7e6; border:1px solid #ffe0a3; font-size:12px; line-height:1.55;
    }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; color:#fff; margin-right:6px; }
    .win{ background:#2e7d32; }
    .lose{ background:#c62828; }
    .stats{ margin-top:8px; font-size:13px; line-height:1.6; }
    .thumb{ max-width:60px; max-height:60px; display:block; }
  </style>
</head>
<body>
<header>
  <h1>対戦記録（ローカル保存＋バックアップ）</h1>
  <button class="danger" id="resetDataButton">データを全部削除</button>
</header>

<main>
  <section class="section">
    <h2>バックアップ</h2>

    <div class="row">
      <div>
        <button class="secondary" id="exportButton">バックアップを書き出し（JSON）</button>
        <div class="small">iPhone・Androidでは「ファイル」に保存できます。</div>
      </div>
      <div>
        <label for="importFile">バックアップを読み込む（JSON）</label>
        <input type="file" id="importFile" accept="application/json" />
        <button class="secondary" id="importButton">読み込みして復元</button>
      </div>
    </div>

    <div class="hint">
      復元をすると、今のデータは上書きされます。復元前に、必ず書き出し（バックアップ）を取ってください。<br>
      ブラウザの「履歴とWebサイトデータの削除」などを行うと、このアプリの記録が消える可能性があります。
    </div>
  </section>

  <div class="grid">
    <section class="section">
      <h2>対戦を記録</h2>

      <h3>対戦を追加</h3>

      <label for="matchDate">対戦日</label>
      <input type="date" id="matchDate" />

      <label for="matchDeckName">使用デッキ名</label>
      <input type="text" id="matchDeckName" placeholder="例：青黒サガ" />

      <label for="matchDeckImage">デッキ画像（任意・1枚）</label>
      <input type="file" id="matchDeckImage" accept="image/*" />
      <div class="small">画像は対戦ごとに保存されます。あまり大きな画像を大量に入れると保存容量に近づきます。</div>

      <div class="row">
        <div>
          <label for="matchRound">ラウンド（第何回戦）</label>
          <input type="number" id="matchRound" min="1" placeholder="例：1" />
        </div>
        <div>
          <label for="matchFirstSecond">先手／後手</label>
          <select id="matchFirstSecond">
            <option value="">選択</option>
            <option value="先手">先手</option>
            <option value="後手">後手</option>
          </select>
        </div>
        <div>
          <label for="matchResult">勝敗</label>
          <select id="matchResult">
            <option value="">選択</option>
            <option value="勝ち">勝ち</option>
            <option value="負け">負け</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="matchScore">マッチスコア（任意）</label>
          <input type="text" id="matchScore" placeholder="例：2-1" />
        </div>
        <div>
          <label for="matchOpponentDeck">相手デッキ名（任意）</label>
          <input type="text" id="matchOpponentDeck" placeholder="例：赤青マジック" />
        </div>
      </div>

      <label for="matchMemo">メモ（任意）</label>
      <textarea id="matchMemo" placeholder="プレイの反省点など"></textarea>

      <button id="addMatchButton">対戦を追加</button>
    </section>

    <section class="section">
      <h2>期間での勝率集計</h2>

      <label for="periodStart">開始日（対戦日）</label>
      <input type="date" id="periodStart" />

      <label for="periodEnd">終了日（対戦日）</label>
      <input type="date" id="periodEnd" />

      <button id="calcPeriodButton">この期間で集計する</button>

      <div class="small">
        対戦日の範囲で集計します。開始日か終了日を空欄にすると、その側は制限なしになります。
      </div>

      <div id="periodResult" class="stats"></div>
    </section>
  </div>

  <section class="section">
    <h2>対戦一覧</h2>

    <div class="stats" id="overallStats"></div>

    <table id="matchTable">
      <thead>
        <tr>
          <th>対戦日</th>
          <th>R</th>
          <th>デッキ画像</th>
          <th>使用デッキ名</th>
          <th>先手／後手</th>
          <th>勝敗</th>
          <th>スコア</th>
          <th>相手デッキ</th>
          <th>メモ</th>
          <th>記録日時</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script>
  // v5: デッキ管理なし。matches だけを持つ。
  const STORAGE_KEY = "dm_match_tracker_data_v5";

  function normalizeMatchesOnly(data){
    if(!data || typeof data !== "object"){
      return { matches: [] };
    }
    if(!Array.isArray(data.matches)){
      data.matches = [];
    }
    return { matches: data.matches };
  }

  // v4以前の tournaments/decks/matches から v5形式へ変換
  function migrateFromOld(data){
    if(!data || typeof data !== "object"){
      return { matches: [] };
    }
    if(!Array.isArray(data.matches)){
      return { matches: [] };
    }

    const tournaments = Array.isArray(data.tournaments) ? data.tournaments : [];
    const decks = Array.isArray(data.decks) ? data.decks : [];

    const tMap = {};
    for(const t of tournaments){
      if(t && t.id && t.date){
        tMap[t.id] = t.date;
      }
    }

    const deckMap = {};
    for(const d of decks){
      if(d && d.id){
        deckMap[d.id] = {
          name: typeof d.name === "string" ? d.name : "",
          imageDataUrl: d.imageDataUrl || null
        };
      }
    }

    const newMatches = [];
    for(const m of data.matches){
      if(!m || typeof m !== "object") continue;

      let matchDate = m.matchDate || "";
      if(!matchDate && m.tournamentId && tMap[m.tournamentId]){
        matchDate = tMap[m.tournamentId];
      }

      let deckName = "";
      let deckImageDataUrl = null;
      if(m.deckId && deckMap[m.deckId]){
        deckName = deckMap[m.deckId].name;
        deckImageDataUrl = deckMap[m.deckId].imageDataUrl || null;
      }

      newMatches.push({
        id: typeof m.id === "string" ? m.id : genId("match"),
        matchDate: matchDate || "",
        deckName: deckName || "",
        deckImageDataUrl: deckImageDataUrl || null,
        roundNumber: m.roundNumber || null,
        firstOrSecond: m.firstOrSecond || "",
        result: m.result || "",
        score: m.score || "",
        opponentDeckName: m.opponentDeckName || "",
        memo: m.memo || "",
        createdAt: m.createdAt || ""
      });
    }

    return { matches: newMatches };
  }

  function loadData(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      try{
        const data = JSON.parse(raw);
        return normalizeMatchesOnly(data);
      }catch{
        return { matches: [] };
      }
    }

    // v4 → v5 自動移行
    const oldRaw = localStorage.getItem("dm_match_tracker_data_v4");
    if(oldRaw){
      try{
        const oldData = JSON.parse(oldRaw);
        const migrated = migrateFromOld(oldData);
        saveData(migrated);
        return migrated;
      }catch{
        return { matches: [] };
      }
    }

    // v3 → v5（古いキーが残っている場合の保険）
    const olderRaw = localStorage.getItem("dm_match_tracker_data_v3");
    if(olderRaw){
      try{
        const olderData = JSON.parse(olderRaw);
        const migrated = migrateFromOld(olderData);
        saveData(migrated);
        return migrated;
      }catch{
        return { matches: [] };
      }
    }

    return { matches: [] };
  }

  function saveData(data){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function genId(prefix){
    return prefix + "_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
  }

  function escapeHtml(v){
    return String(v ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function nowFileTime(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()+0).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}_${hh}${mi}`;
  }

  function createdAtString(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()+0).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
  }

  function todayDate(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function validateImportedData(data){
    if(!data || typeof data !== "object") return "JSONの中身が不正です。";

    // v5形式（matchesのみ）
    if(Array.isArray(data.matches) && !Array.isArray(data.decks) && !Array.isArray(data.tournaments)){
      for(const m of data.matches){
        if(!m || typeof m !== "object") return "対戦データが不正です。";
      }
      return null;
    }

    // v3/v4形式（tournaments/decks/matches）
    if(Array.isArray(data.matches) && Array.isArray(data.decks)){
      for(const d of data.decks){
        if(!d || typeof d !== "object") return "デッキデータが不正です。";
      }
      for(const m of data.matches){
        if(!m || typeof m !== "object") return "対戦データが不正です。";
      }
      return null;
    }

    return "形式が対応外です。";
  }

  let appData = loadData();

  function overallStats(){
    let total = 0, win = 0, lose = 0;
    for(const m of appData.matches){
      total++;
      if(m.result === "勝ち") win++;
      if(m.result === "負け") lose++;
    }
    return { total, win, lose };
  }

  function percent(win, total){
    if(!total) return null;
    return Math.round((win / total) * 1000) / 10;
  }

  function renderMatches(){
    const tbody = document.querySelector("#matchTable tbody");
    tbody.innerHTML = "";

    const list = [...appData.matches].sort((a,b) => {
      const da = a.matchDate || "";
      const db = b.matchDate || "";
      if(da === db){
        return (a.roundNumber || 0) - (b.roundNumber || 0);
      }
      return da < db ? -1 : 1;
    });

    for(const m of list){
      const resultHtml = m.result === "勝ち"
        ? `<span class="badge win">勝ち</span>`
        : (m.result === "負け" ? `<span class="badge lose">負け</span>` : "");

      const tr = document.createElement("tr");

      const tdDate = document.createElement("td");
      tdDate.textContent = m.matchDate || "";
      tr.appendChild(tdDate);

      const tdRound = document.createElement("td");
      tdRound.textContent = m.roundNumber != null ? String(m.roundNumber) : "";
      tr.appendChild(tdRound);

      const tdImg = document.createElement("td");
      if(m.deckImageDataUrl){
        const img = document.createElement("img");
        img.src = m.deckImageDataUrl;
        img.alt = m.deckName || "";
        img.className = "thumb";
        tdImg.appendChild(img);
      }
      tr.appendChild(tdImg);

      const tdDeck = document.createElement("td");
      tdDeck.textContent = m.deckName || "";
      tr.appendChild(tdDeck);

      const tdFS = document.createElement("td");
      tdFS.textContent = m.firstOrSecond || "";
      tr.appendChild(tdFS);

      const tdResult = document.createElement("td");
      tdResult.innerHTML = resultHtml;
      tr.appendChild(tdResult);

      const tdScore = document.createElement("td");
      tdScore.textContent = m.score || "";
      tr.appendChild(tdScore);

      const tdOpp = document.createElement("td");
      tdOpp.textContent = m.opponentDeckName || "";
      tr.appendChild(tdOpp);

      const tdMemo = document.createElement("td");
      tdMemo.textContent = m.memo || "";
      tr.appendChild(tdMemo);

      const tdCreated = document.createElement("td");
      tdCreated.textContent = m.createdAt || "";
      tr.appendChild(tdCreated);

      tbody.appendChild(tr);
    }

    const s = overallStats();
    const rate = percent(s.win, s.total);
    const overallDiv = document.getElementById("overallStats");
    if(!s.total){
      overallDiv.textContent = "まだ対戦記録がありません。";
    }else{
      overallDiv.textContent =
        `全対戦数: ${s.total}　勝ち: ${s.win}　負け: ${s.lose}` +
        (rate != null ? `　勝率: ${rate}%` : "");
    }
  }

  function calcPeriodStats(startDate, endDate){
    let total = 0;
    let win = 0;
    let lose = 0;
    let firstTotal = 0;
    let firstWin = 0;
    let secondTotal = 0;
    let secondWin = 0;

    for(const m of appData.matches){
      const d = m.matchDate;
      if(!d) continue;
      if(startDate && d < startDate) continue;
      if(endDate && d > endDate) continue;

      total++;
      if(m.result === "勝ち") win++;
      if(m.result === "負け") lose++;

      if(m.firstOrSecond === "先手"){
        firstTotal++;
        if(m.result === "勝ち") firstWin++;
      }
      if(m.firstOrSecond === "後手"){
        secondTotal++;
        if(m.result === "勝ち") secondWin++;
      }
    }

    return { total, win, lose, firstTotal, firstWin, secondTotal, secondWin };
  }

  document.getElementById("addMatchButton").addEventListener("click", () => {
    let matchDate = document.getElementById("matchDate").value;
    const deckName = document.getElementById("matchDeckName").value.trim();
    const fileInput = document.getElementById("matchDeckImage");
    const file = fileInput.files && fileInput.files[0];
    const roundStr = document.getElementById("matchRound").value;
    const firstOrSecond = document.getElementById("matchFirstSecond").value;
    const result = document.getElementById("matchResult").value;
    const score = document.getElementById("matchScore").value.trim();
    const opponentDeckName = document.getElementById("matchOpponentDeck").value.trim();
    const memo = document.getElementById("matchMemo").value.trim();

    if(!matchDate){
      matchDate = todayDate();
    }
    if(!deckName){
      alert("使用デッキ名を入力してください。");
      return;
    }

    const roundNumber = roundStr ? parseInt(roundStr, 10) : 0;
    if(!roundNumber || roundNumber <= 0){
      alert("ラウンドを1以上の数値で入力してください。");
      return;
    }
    if(!firstOrSecond){
      alert("先手／後手を選択してください。");
      return;
    }
    if(!result){
      alert("勝敗（勝ち／負け）を選択してください。");
      return;
    }

    function addMatch(deckImageDataUrl){
      appData.matches.push({
        id: genId("match"),
        matchDate,
        deckName,
        deckImageDataUrl: deckImageDataUrl || null,
        roundNumber,
        firstOrSecond,
        result,
        score,
        opponentDeckName,
        memo,
        createdAt: createdAtString()
      });
      saveData(appData);
      renderMatches();

      document.getElementById("matchDeckName").value = "";
      document.getElementById("matchRound").value = "";
      document.getElementById("matchFirstSecond").value = "";
      document.getElementById("matchResult").value = "";
      document.getElementById("matchScore").value = "";
      document.getElementById("matchOpponentDeck").value = "";
      document.getElementById("matchMemo").value = "";
      fileInput.value = "";
    }

    if(file){
      const reader = new FileReader();
      reader.onload = () => {
        addMatch(String(reader.result || ""));
      };
      reader.readAsDataURL(file);
    }else{
      addMatch(null);
    }
  });

  document.getElementById("resetDataButton").addEventListener("click", () => {
    const ok = confirm("保存している対戦データをすべて削除します。よろしいですか？");
    if(!ok) return;
    appData = { matches: [] };
    saveData(appData);
    renderMatches();
    document.getElementById("periodResult").textContent = "";
  });

  document.getElementById("exportButton").addEventListener("click", () => {
    const payload = {
      version: 5,
      exportedAt: new Date().toISOString(),
      matches: appData.matches
    };
    const json = JSON.stringify(payload, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `match_backup_${nowFileTime()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  document.getElementById("importButton").addEventListener("click", () => {
    const fileInput = document.getElementById("importFile");
    if(!fileInput.files || fileInput.files.length === 0){
      alert("読み込むJSONファイルを選択してください。");
      return;
    }

    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const data = JSON.parse(String(reader.result || ""));
        const err = validateImportedData(data);
        if(err){
          alert("復元できません：" + err);
          return;
        }

        let converted;
        if(Array.isArray(data.matches) && !Array.isArray(data.decks) && !Array.isArray(data.tournaments)){
          converted = normalizeMatchesOnly(data);
        }else{
          converted = migrateFromOld(data);
        }

        const ok = confirm("復元を実行します。今のデータは上書きされます。よろしいですか？");
        if(!ok) return;

        appData = converted;
        saveData(appData);
        renderMatches();
        document.getElementById("periodResult").textContent = "";
        fileInput.value = "";
        alert("復元しました。");
      }catch{
        alert("JSONの読み込みに失敗しました。");
      }
    };
    reader.readAsText(file, "utf-8");
  });

  document.getElementById("calcPeriodButton").addEventListener("click", () => {
    const startDate = document.getElementById("periodStart").value;
    const endDate = document.getElementById("periodEnd").value;

    if(startDate && endDate && startDate > endDate){
      alert("開始日は終了日以前にしてください。");
      return;
    }

    const stats = calcPeriodStats(startDate, endDate);
    const div = document.getElementById("periodResult");

    if(stats.total === 0){
      div.textContent = "この期間に集計対象の対戦はありません。";
      return;
    }

    const gameRate = percent(stats.win, stats.total);
    const firstRate = percent(stats.firstWin, stats.firstTotal);
    const secondRate = percent(stats.secondWin, stats.secondTotal);

    const startLabel = startDate || "指定なし";
    const endLabel = endDate || "指定なし";

    div.innerHTML =
      `対象期間: ${escapeHtml(startLabel)} 〜 ${escapeHtml(endLabel)}<br>` +
      `対戦数: ${stats.total}<br>` +
      `ゲーム勝率: 勝ち ${stats.win} / ${stats.total}` +
      (gameRate != null ? `（${gameRate}%）` : "") + `<br>` +
      `先手: 勝ち ${stats.firstWin} / ${stats.firstTotal}` +
      (firstRate != null ? `（${firstRate}%）` : "") + `<br>` +
      `後手: 勝ち ${stats.secondWin} / ${stats.secondTotal}` +
      (secondRate != null ? `（${secondRate}%）` : "");
  });

  function init(){
    document.getElementById("matchDate").value = todayDate();
    renderMatches();
  }
  init();
</script>
</body>
</html>
