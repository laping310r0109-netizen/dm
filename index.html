/* =========================
   Supabase 認証・クラウド保存
========================= */
const SUPABASE_URL = "https://fhtgpmaofiiexppowvqd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZodGdwbWFvZmlpZXhwcG93dnFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0OTk3OTIsImV4cCI6MjA4NDA3NTc5Mn0.qgElUy71dfguW99f6gztRwXPuEFc87mV6oYW3AmCC9M";

let supabaseClient = null;
let currentUser = null;

function updateCloudUi(){
  const statusEl = document.getElementById("cloudStatus");
  const loginBtn = document.getElementById("googleLoginButton");
  const logoutBtn = document.getElementById("googleLogoutButton");
  const saveBtn = document.getElementById("cloudSaveButton");
  const loadBtn = document.getElementById("cloudLoadButton");

  if(!statusEl || !loginBtn || !logoutBtn || !saveBtn || !loadBtn) return;

  if(currentUser){
    const email = currentUser.email || "(メール未取得)";
    statusEl.textContent = `ログイン中: ${email}`;
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
    saveBtn.disabled = false;
    loadBtn.disabled = false;
  }else{
    statusEl.textContent = "ログインしていません。";
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    saveBtn.disabled = true;
    loadBtn.disabled = true;
  }
}

async function initSupabaseAuth(){
  if(typeof supabase === "undefined"){
    console.error("supabase-js が読み込まれていません。");
    return;
  }

  supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth:{
      persistSession:true,
      autoRefreshToken:true,
      detectSessionInUrl:true
    }
  });

  const { data, error } = await supabaseClient.auth.getUser();
  if(error){
    console.warn("auth.getUser error", error);
    currentUser = null;
  }else{
    currentUser = data.user ?? null;
  }
  updateCloudUi();

  supabaseClient.auth.onAuthStateChange((_event, session)=>{
    currentUser = session?.user ?? null;
    updateCloudUi();
  });
}

async function handleGoogleLogin(){
  if(!supabaseClient){
    alert("Supabase クライアントが初期化されていません。");
    return;
  }
  try{
    const redirectTo = window.location.origin + window.location.pathname;
    const { data, error } = await supabaseClient.auth.signInWithOAuth({
      provider: "google",
      options: { redirectTo }
    });
    if(error){
      alert("ログインに失敗しました: " + error.message);
      return;
    }
    if(data?.url){
      window.location.href = data.url;
    }
  }catch(e){
    console.error(e);
    alert("ログイン処理中にエラーが発生しました。");
  }
}

async function handleGoogleLogout(){
  if(!supabaseClient) return;
  try{
    const { error } = await supabaseClient.auth.signOut();
    if(error){
      alert("ログアウトに失敗しました: " + error.message);
      return;
    }
    currentUser = null;
    updateCloudUi();
  }catch(e){
    console.error(e);
    alert("ログアウト処理中にエラーが発生しました。");
  }
}

async function handleCloudSave(){
  if(!supabaseClient || !currentUser){
    alert("まず Google でログインしてください。");
    return;
  }
  try{
    const userId = currentUser.id;

    // アプリ全体のデータ(appData)をそのままJSONとして保存
    const payload = {
      user_id: userId,
      data: appData,
      created_at: new Date().toISOString()  // 上書き時も現在時刻に更新
    };

    const { error } = await supabaseClient
      .from("match_backups")                // ← テーブル名
      .upsert(payload, { onConflict: "user_id" });

    if(error){
      console.error(error);
      alert("クラウド保存に失敗しました。");
      return;
    }
    alert("クラウドに保存しました。");
  }catch(e){
    console.error(e);
    alert("クラウド保存中にエラーが発生しました。");
  }
}

async function handleCloudLoad(){
  if(!supabaseClient || !currentUser){
    alert("まず Google でログインしてください。");
    return;
  }
  if(!confirm("クラウド上のバックアップで、今のデータを上書きします。よろしいですか？")) return;

  try{
    const userId = currentUser.id;
    const { data, error } = await supabaseClient
      .from("match_backups")       // ← テーブル名
      .select("data")
      .eq("user_id", userId)
      .single();

    if(error){
      console.error(error);
      alert("クラウドからバックアップを取得できませんでした。");
      return;
    }
    if(!data || !data.data){
      alert("このユーザーのクラウドバックアップがありません。");
      return;
    }

    const parsed = data.data;      // jsonb をそのままオブジェクトとして取得
    if(!parsed || !Array.isArray(parsed.matches)){
      alert("クラウドバックアップの形式が不正です。");
      return;
    }

    appData = parsed;
    saveData(appData);
    renderMatches();
    clearForm();
    document.getElementById("periodResult").textContent = "";

    alert("クラウドバックアップから復元しました。");
  }catch(e){
    console.error(e);
    alert("クラウド復元中にエラーが発生しました。");
  }
}
